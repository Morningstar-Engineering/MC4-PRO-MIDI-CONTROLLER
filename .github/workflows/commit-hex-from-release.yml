name: Commit .hex release assets into /releases

on:
  release:
    types: [published, edited]   # <â€” run on initial publish AND later asset changes

permissions:
  contents: write

concurrency:
  group: commit-hex-from-release-${{ github.event.release.id }}
  cancel-in-progress: false

jobs:
  commit-hex:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          mkdir -p _release_download
          gh release download "$TAG" --dir _release_download

      - name: Copy only .hex files into releases/<tag>/
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p releases/"$TAG"

          hex_files=( _release_download/*.hex )
          if (( ${#hex_files[@]} == 0 )); then
            echo "No .hex assets found in this release."
            exit 0
          fi

          cp -f "${hex_files[@]}" releases/"$TAG"/

      - name: Commit and push if changed
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add releases/"$TAG"
          git commit -m "Add .hex release assets for $TAG"
          git push
